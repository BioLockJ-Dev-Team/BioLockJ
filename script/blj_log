#!/bin/bash
###########################################################################
##                                                                       ##
##  This script tails 1K lines from the current pipelines Java log file. ##
##  If the current directory is not a BioLockJ pipeline, print the       ##
##  tail 1K lines from the most recent pipeline executed.                ##
##                                                                       ##
###########################################################################

function valid_dir {
	if [ ${#1} -gt 0 ] && [ -d "$1" ]; then  
		echo "Y" 
	else 
		echo "N"
	fi
}

function most_recent_pipeline {
	if [ "$(valid_dir $BLJ_PROJ)" == "Y" ]; then
		dir=$( \ls -t $BLJ_PROJ | head -1 )
		if [ ${#dir} -gt 0 ] && [ "$(valid_dir $BLJ_PROJ/$dir)" == "Y" ]; then
			echo "$BLJ_PROJ/$dir"
		else
			echo ""
		fi
   fi
}

function current_pipeline {
	if [ "$(valid_dir $BLJ_PROJ)" == "Y" ]; then
		dir=$PWD
		parentDir="$(dirname $dir)"
		while [ ${#parentDir} -gt 0 ] && [ "$parentDir" != "$BLJ_PROJ" ] && [  "$parentDir" != "$(dirname $parentDir)" ] 
		do
			dir=$parentDir
			parentDir="$(dirname $parentDir)"
		done
		[ ${#parentDir} -gt 0 ] && [ "$parentDir" == "$BLJ_PROJ" ] && echo $dir
		[ ${#parentDir} -eq "0" ] && echo ""
   fi
}

pipeline=$(current_pipeline)
if [ ${#pipeline} -gt 0 ]; then
	echo "Tail current BioLockJ pipeline log: $pipeline"
else
	pipeline=$(most_recent_pipeline)
	[ ${#pipeline} -gt 0 ] && echo "Tail most recent BioLockJ pipeline log: $pipeline"
fi

if [ ${#pipeline} -gt 0 ]; then
	\tail -1000f $pipeline/*.log 
else
	echo "No pipeline directories found in BLJ_PROJ: $BLJ_PROJ"
fi
